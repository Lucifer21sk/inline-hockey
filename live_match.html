<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Live Match</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Shared global style -->
  <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="match-container">

  <!-- HOME -->
  <div class="team-panel">
    <img id="homeLogo" class="team-logo">
    <h2 id="homeName">DOMÁCI</h2>

    <div class="team-spacer"></div>

    <div class="team-actions">
      <button class="goal-btn" onclick="openGoal('home')">Gól</button>
      <button class="penalty-btn" onclick="openPenalty('home')">Trest</button>
    </div>
  </div>

  <!-- CENTER -->
  <div class="center-stack">

    <div class="score-box">
      <span id="homeScore">0</span>
      :
      <span id="awayScore">0</span>
    </div>

    <div class="match-phase" id="matchPhase">
      Normálny čas
    </div>

    <div class="phase-buttons center-phase-buttons">
      <button onclick="startOvertime()">Predĺženie</button>
      <button onclick="startShootout()">Trestné strieľania</button>
    </div>

  </div>


  <!-- AWAY -->
  <div class="team-panel">
    <img id="awayLogo" class="team-logo">
    <h2 id="awayName">HOSTIA</h2>

    <div class="team-spacer"></div>

    <div class="team-actions">
      <button class="goal-btn" onclick="openGoal('away')">Gól</button>
      <button class="penalty-btn" onclick="openPenalty('away')">Trest</button>
    </div>
  </div>

</div>

<!-- END MATCH BUTTON -->
 <button class="action-btn end-match-btn" onclick="endMatch()">
  Koniec zápasu
</button>

<!-- ===== GOAL MODAL ===== -->
<div id="goalModal" class="modal">
  <div class="modal-box">
    <h3>GÓL</h3>

    <input id="goalTime" placeholder="Čas (mm:ss)" inputmode="numeric">
    <input placeholder="Strelec – číslo" id="goalScorer" inputmode="numeric" pattern="[0-9]*">
    <input placeholder="Asistencia 1" id="goalAssist1" inputmode="numeric" pattern="[0-9]*">
    <input placeholder="Asistencia 2" id="goalAssist2" inputmode="numeric" pattern="[0-9]*">

    <div class="modal-actions">
      <button class="modal-cancel" onclick="closeModal()">Zrušiť</button>
      <button class="modal-confirm" onclick="confirmGoal()">✓</button>
    </div>
  </div>
</div>

<!-- ===== PENALTY MODAL ===== -->
<div id="penaltyModal" class="modal">
  <div class="modal-box">
    <h3>TREST</h3>

    <input id="penaltyTime" placeholder="Čas (mm:ss)" inputmode="numeric">
    <input placeholder="Hráč – číslo" id="penaltyPlayer" inputmode="numeric" pattern="[0-9]*">

    <select id="penaltyType">
      <option>2 min</option>
      <option>2 + 2</option>
      <option>10 min</option>
      <option>Do konca zápasu</option>
    </select>

    <div class="modal-actions">
      <button class="modal-cancel" onclick="closeModal()">Zrušiť</button>
      <button class="modal-confirm" onclick="confirmPenalty()">✓</button>
    </div>
  </div>
</div>

<script>

function clearGoalModal() {
  document.getElementById("goalTime").value = "";
  document.getElementById("goalScorer").value = "";
  document.getElementById("goalAssist1").value = "";
  document.getElementById("goalAssist2").value = "";
}

function clearPenaltyModal() {
  document.getElementById("penaltyTime").value = "";
  document.getElementById("penaltyPlayer").value = "";
  document.getElementById("penaltyType").value = "";
}

const params = new URLSearchParams(window.location.search);

const homeTeamId = Number(params.get("home"));
const awayTeamId = Number(params.get("away"));

let homeTeam = null;
let awayTeam = null;
let teamsLoaded = false;

let homeScore = 0;
let awayScore = 0;
let activeTeam = null;

let currentPhase = "normal"; // normal, overtime, shootout

let matchId = null;

const goalModal = document.getElementById("goalModal");
const penaltyModal = document.getElementById("penaltyModal");

function updatePhaseUI() {
  const phaseLabel = document.getElementById("matchPhase");

  // reset classes
  phaseLabel.classList.remove(
    "phase-normal",
    "phase-overtime",
    "phase-shootout"
  );

  if (currentPhase === "normal") {
    phaseLabel.innerText = "Normálny čas";
    phaseLabel.classList.add("phase-normal");
  }

  if (currentPhase === "Predĺženie") {
    phaseLabel.innerText = "Predĺženie";
    phaseLabel.classList.add("phase-overtime");
  }

  if (currentPhase === "Trestné strieľania") {
    phaseLabel.innerText = "Trestné strieľania";
    phaseLabel.classList.add("phase-shootout");
  }
}


function startOvertime() {
  currentPhase = "Predĺženie";
  updatePhaseUI();
}

function startShootout() {
  currentPhase = "Trestné strieľania";
  updatePhaseUI();
}

/* =========================
   LOAD TEAM NAMES + LOGOS
   ========================= */
async function loadTeamLogos() {
  try {
    const res = await fetch("https://Lucifer21sk.pythonanywhere.com/teams");
    const teams = await res.json();

    homeTeam = teams.find(t => t.id === homeTeamId);
    awayTeam = teams.find(t => t.id === awayTeamId);

    if (!homeTeam || !awayTeam) {
      console.error("Team IDs not found", homeTeamId, awayTeamId);
      return;
    }

    document.getElementById("homeName").innerText = homeTeam.name;
    document.getElementById("awayName").innerText = awayTeam.name;

    document.getElementById("homeLogo").src = "logos/" + homeTeam.logo;
    document.getElementById("awayLogo").src = "logos/" + awayTeam.logo;

    teamsLoaded = true;
    console.log("Teams loaded:", homeTeam.id, awayTeam.id);
    createMatch();

  } catch (err) {
    console.error("Failed to load teams", err);
  }
}

loadTeamLogos();

async function createMatch() {
  try {
    const res = await fetch(
      "https://Lucifer21sk.pythonanywhere.com/matches/create",
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          home_team_id: homeTeamId,
          away_team_id: awayTeamId
        })
      }
    );

    const data = await res.json();

    if (data.status === "ok") {
      matchId = data.match_id;
      console.log("Match created:", matchId);
    }

  } catch (err) {
    console.error("Match create failed", err);
  }
}


/* =========================
   MODAL HANDLING
   ========================= */
function openGoal(team) {
  activeTeam = team;
  goalModal.classList.add("active");
}

function openPenalty(team) {
  activeTeam = team;
  penaltyModal.classList.add("active");
}

function closeModal() {
  goalModal.classList.remove("active");
  penaltyModal.classList.remove("active");
}

/* =========================
   AUTO FORMAT TIME INPUT
   ========================= */
function setupTimeInput(id) {
  const input = document.getElementById(id);

  input.addEventListener("input", () => {
    let digits = input.value.replace(/\D/g, "").slice(0, 4);
    if (digits.length >= 3) {
      input.value = digits.slice(0, 2) + ":" + digits.slice(2);
    } else {
      input.value = digits;
    }
  });
}

setupTimeInput("goalTime");
setupTimeInput("penaltyTime");

/* =========================
   CONFIRM GOAL (NEW)
   ========================= */
async function confirmGoal() {
  const minute = document.getElementById("goalTime").value;
  const scorer = document.getElementById("goalScorer").value;
  const assist1 = document.getElementById("goalAssist1").value;
  const assist2 = document.getElementById("goalAssist2").value;

  if (!minute || !scorer) {
    alert("Vyplň čas a strelca");
    return;
  }

  if (!teamsLoaded) {
    alert("Tímy sa ešte načítavajú, počkaj sekundu...");
    return;
  }

  const teamId = activeTeam === "home" ? homeTeamId : awayTeamId;

  const payload = {
    match_id: matchId,
    team_id: teamId,
    scorer_number: Number(scorer),
    assist1_number: assist1 ? Number(assist1) : null,
    assist2_number: assist2 ? Number(assist2) : null,
    minute: minute
  };

  try {
    const res = await fetch("https://Lucifer21sk.pythonanywhere.com/goal", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const result = await res.json();

    if (result.status === "ok") {
      // update score ONLY after server success
      if (activeTeam === "home") {
        homeScore++;
        document.getElementById("homeScore").textContent = homeScore;
      } else {
        awayScore++;
        document.getElementById("awayScore").textContent = awayScore;
      }

      clearGoalModal();
      closeModal();
    } else {
      console.error("Server error", result);
      alert("Chyba pri ukladaní gólu");
    }

  } catch (err) {
    console.error(err);
    alert("Chyba spojenia so serverom");
  }
}

/* =========================
   CONFIRM PENALTY 
   ========================= */
async function confirmPenalty() {
  const minute = document.getElementById("penaltyTime").value;
  const player = document.getElementById("penaltyPlayer").value;
  const type = document.getElementById("penaltyType").value;

  if (!minute || !player || !type) {
    alert("Vyplň všetky polia");
    return;
  }

  if (!teamsLoaded) {
    alert("Tímy sa ešte načítavajú, počkaj sekundu...");
    return;
  }

  const teamId = activeTeam === "home" ? homeTeamId : awayTeamId;

  const payload = {
    match_id: matchId,
    team_id: teamId,
    player_number: Number(player),
    minute: minute,
    type: type
  };

  try {
    const res = await fetch("https://Lucifer21sk.pythonanywhere.com/penalty", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const result = await res.json();

    if (result.status === "ok") {
      clearPenaltyModal();
      closeModal();
    } else {
      console.error("Server error", result);
    }

  } catch (err) {
    console.error(err);
    alert("Chyba spojenia so serverom");
  }
}

/* =========================
   END MATCH
   ========================= */
async function endMatch() {
  try {

    let winner = null;

    if (homeScore > awayScore) winner = homeTeamId;
    if (awayScore > homeScore) winner = awayTeamId;

    if (!winner) {
      alert("Remíza nie je možná — musí byť víťaz");
      return;
    }

    await fetch(
      "https://Lucifer21sk.pythonanywhere.com/matches/end",
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          match_id: matchId,
          winner_team_id: winner,
          phase: currentPhase
        })
      }
    );

    window.location.href = "post_match.html";

  } catch (err) {
    console.error("End match failed", err);
  }
}

</script>


</body>
</html>