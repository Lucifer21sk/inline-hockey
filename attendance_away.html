<!DOCTYPE html>
<html lang="sk">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dochádzka – Hostia</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <h1>HOSTIA</h1>

  <div class="table-scroll">
    <table>
      <thead>
        <tr>
          <th></th>
          <th>Meno</th>
          <th>Číslo</th>
        </tr>
      </thead>
      <tbody id="playersBody">
        </tbody>
    </table>
  </div>

  <button id="continueBtn" class="action-btn" disabled>
    Pokračovať
  </button>

<script>
    const params = new URLSearchParams(window.location.search);
    const homeTeamId = params.get("home");
    const awayTeamId = params.get("away");
    const matchId = params.get("match_id"); // <--- GET MATCH ID

    const tbody = document.getElementById("playersBody");
    const continueBtn = document.getElementById("continueBtn");

    function updateButtonState() {
      const checked = document.querySelectorAll('.player-checkbox:checked');
      continueBtn.disabled = checked.length < 5;
    }

    async function loadPlayers() {
      try {
          const response = await fetch(`https://Lucifer21sk.pythonanywhere.com/players/${awayTeamId}`);
          const players = await response.json();
          tbody.innerHTML = "";
          players.forEach(player => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td><input type="checkbox" class="player-checkbox" data-id="${player.id}"></td>
              <td>${player.name}</td>
              <td><input type="number" class="player-number" value="${player.number}" style="width: 60px; font-size: 18px; padding: 5px;"></td>
            `;
            tbody.appendChild(tr);
          });
          document.querySelectorAll(".player-checkbox").forEach(cb => cb.addEventListener("change", updateButtonState));
      } catch (err) { console.error(err); alert("Chyba pri načítaní hráčov."); }
    }

    continueBtn.addEventListener("click", async () => {
        const selectedPlayers = [];
        document.querySelectorAll(".player-checkbox:checked").forEach(cb => {
            const row = cb.closest("tr");
            const pId = cb.getAttribute("data-id");
            const pNumber = row.querySelector(".player-number").value;
            selectedPlayers.push({ player_id: parseInt(pId), number: parseInt(pNumber) });
        });

        const homeRosterString = localStorage.getItem("homeRoster");
        if (!homeRosterString) { alert("Chyba: Chýba domáca súpiska!"); return; }
        const homeRoster = JSON.parse(homeRosterString);

        // DECIDE: START EXISTING MATCH or CREATE NEW?
        let apiUrl = "https://Lucifer21sk.pythonanywhere.com/matches/create"; // Default (Legacy)
        let payload = {
            home_team_id: homeTeamId,
            away_team_id: awayTeamId,
            home_roster: homeRoster,
            away_roster: selectedPlayers
        };

        if (matchId) {
            // NEW: Use the scheduled match ID
            apiUrl = "https://Lucifer21sk.pythonanywhere.com/matches/start_scheduled";
            payload.match_id = matchId;
        }

        try {
            const response = await fetch(apiUrl, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            const data = await response.json();

            if (data.status === "ok") {
                localStorage.removeItem("homeRoster");
                // Redirect to Live Match
                window.location.href = `live_match.html?match=${data.match_id}&home=${homeTeamId}&away=${awayTeamId}`;
            } else {
                alert("Chyba pri vytváraní zápasu.");
            }
        } catch (err) { console.error(err); alert("Chyba siete."); }
    });

    loadPlayers();
</script>
</body>
</html>